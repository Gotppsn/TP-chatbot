@{
    ViewData["Title"] = "Settings";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Settings</h1>
        <p class="text-muted">Configure your AI Helpdesk platform</p>
    </div>
    <div class="page-actions">
        <button id="saveSettings" class="btn btn-primary">
            <i class="bi bi-check-lg"></i>
            Save Changes
        </button>
    </div>
</div>

<div class="settings-layout">
    <!-- Settings Navigation -->
    <div class="settings-nav">
        <div class="nav-section">
            <div class="nav-section-title">General</div>
            <ul class="nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#general" type="button"
                        role="tab">
                        <i class="bi bi-gear"></i>
                        <span>General</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
                        <i class="bi bi-palette"></i>
                        <span>Appearance</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notifications" type="button"
                        role="tab">
                        <i class="bi bi-bell"></i>
                        <span>Notifications</span>
                    </button>
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">AI Configuration</div>
            <ul class="nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ai-models" type="button" role="tab">
                        <i class="bi bi-cpu"></i>
                        <span>AI Models</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#departments" type="button"
                        role="tab">
                        <i class="bi bi-building"></i>
                        <span>Departments</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prompts" type="button" role="tab">
                        <i class="bi bi-chat-left-text"></i>
                        <span>Default Prompts</span>
                    </button>
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">System</div>
            <ul class="nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#integrations" type="button"
                        role="tab">
                        <i class="bi bi-box-seam"></i>
                        <span>Integrations</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                        <i class="bi bi-people"></i>
                        <span>Users</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#api-keys" type="button" role="tab">
                        <i class="bi bi-key"></i>
                        <span>API Keys</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                        <i class="bi bi-sliders"></i>
                        <span>Advanced</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="settings-content">
        <div class="tab-content">
            <!-- General Settings -->
            <div class="tab-pane fade show active" id="general" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>General Settings</h2>
                        <p>Basic configuration for your AI Helpdesk platform</p>
                    </div>

                    <div class="panel-body">
                        <div class="settings-section">
                            <div class="form-group">
                                <label for="organizationName" class="form-label">Organization Name</label>
                                <input type="text" id="organizationName" class="form-control"
                                    value="AI Helpdesk Support">
                                <div class="form-text">This name will appear throughout the platform and in emails</div>
                            </div>

                            <div class="form-group">
                                <label for="supportEmail" class="form-label">Support Email</label>
                                <input type="email" id="supportEmail" class="form-control" value="support@example.com">
                                <div class="form-text">Escalated tickets and notifications will be sent to this address
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="defaultLanguage" class="form-label">Default Language</label>
                                <select id="defaultLanguage" class="form-select">
                                    <option value="en" selected>English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="ja">Japanese</option>
                                    <option value="zh">Chinese</option>
                                </select>
                                <div class="form-text">Default language for the platform interface</div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Regional Settings</h3>

                            <div class="form-group">
                                <label for="timeZone" class="form-label">Time Zone</label>
                                <select id="timeZone" class="form-select">
                                    <option value="UTC" selected>UTC</option>
                                    <option value="America/New_York">Eastern Time (UTC-5)</option>
                                    <option value="America/Chicago">Central Time (UTC-6)</option>
                                    <option value="America/Denver">Mountain Time (UTC-7)</option>
                                    <option value="America/Los_Angeles">Pacific Time (UTC-8)</option>
                                    <option value="Europe/London">London (UTC+0)</option>
                                    <option value="Europe/Paris">Central Europe (UTC+1)</option>
                                    <option value="Asia/Tokyo">Tokyo (UTC+9)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dateFormat" class="form-label">Date Format</label>
                                <select id="dateFormat" class="form-select">
                                    <option value="MM/DD/YYYY" selected>MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Session Settings</h3>

                            <div class="setting-item">
                                <div class="setting-item-info">
                                    <div class="setting-item-title">Session Timeout</div>
                                    <div class="setting-item-description">Automatically log out users after a period of
                                        inactivity</div>
                                </div>
                                <div class="setting-item-control">
                                    <select class="form-select form-select-sm">
                                        <option value="15">15 minutes</option>
                                        <option value="30" selected>30 minutes</option>
                                        <option value="60">1 hour</option>
                                        <option value="120">2 hours</option>
                                        <option value="0">Never</option>
                                    </select>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-item-info">
                                    <div class="setting-item-title">Remember User Sessions</div>
                                    <div class="setting-item-description">Allow users to stay logged in between browser
                                        sessions</div>
                                </div>
                                <div class="setting-item-control">
                                    <div class="form-switch">
                                        <input type="checkbox" id="rememberSessions" class="form-switch-input" checked>
                                        <label for="rememberSessions" class="form-switch-label"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appearance Settings -->
            <div class="tab-pane fade" id="appearance" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Appearance Settings</h2>
                        <p>Customize the look and feel of your AI Helpdesk</p>
                    </div>

                    <div class="panel-body">
                        <div class="settings-section">
                            <h3>Theme</h3>

                            <div class="theme-options">
                                <div class="theme-option">
                                    <input type="radio" name="theme" id="theme-light" class="theme-radio" checked>
                                    <label for="theme-light" class="theme-label">
                                        <div class="theme-preview light-theme"></div>
                                        <div class="theme-name">Light</div>
                                    </label>
                                </div>

                                <div class="theme-option">
                                    <input type="radio" name="theme" id="theme-dark" class="theme-radio">
                                    <label for="theme-dark" class="theme-label">
                                        <div class="theme-preview dark-theme"></div>
                                        <div class="theme-name">Dark</div>
                                    </label>
                                </div>

                                <div class="theme-option">
                                    <input type="radio" name="theme" id="theme-system" class="theme-radio">
                                    <label for="theme-system" class="theme-label">
                                        <div class="theme-preview system-theme"></div>
                                        <div class="theme-name">System</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Accent Color</h3>

                            <div class="color-options">
                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-blue" class="color-radio" checked>
                                    <label for="color-blue" class="color-label" style="--color: #0d6efd"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-indigo" class="color-radio">
                                    <label for="color-indigo" class="color-label" style="--color: #6610f2"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-purple" class="color-radio">
                                    <label for="color-purple" class="color-label" style="--color: #6f42c1"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-pink" class="color-radio">
                                    <label for="color-pink" class="color-label" style="--color: #d63384"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-red" class="color-radio">
                                    <label for="color-red" class="color-label" style="--color: #dc3545"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-orange" class="color-radio">
                                    <label for="color-orange" class="color-label" style="--color: #fd7e14"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-yellow" class="color-radio">
                                    <label for="color-yellow" class="color-label" style="--color: #ffc107"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-green" class="color-radio">
                                    <label for="color-green" class="color-label" style="--color: #198754"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-teal" class="color-radio">
                                    <label for="color-teal" class="color-label" style="--color: #20c997"></label>
                                </div>

                                <div class="color-option">
                                    <input type="radio" name="accent-color" id="color-cyan" class="color-radio">
                                    <label for="color-cyan" class="color-label" style="--color: #0dcaf0"></label>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Chatbot Appearance</h3>

                            <div class="form-group">
                                <label class="form-label">Chat Window Size</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chatSize" id="chatSize1" checked>
                                    <label class="form-check-label" for="chatSize1">
                                        Compact
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chatSize" id="chatSize2">
                                    <label class="form-check-label" for="chatSize2">
                                        Medium
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chatSize" id="chatSize3">
                                    <label class="form-check-label" for="chatSize3">
                                        Large
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-item-info">
                                    <div class="setting-item-title">Show typing indicator</div>
                                    <div class="setting-item-description">Display "Bot is typing..." animation when the
                                        AI is generating a response</div>
                                </div>
                                <div class="setting-item-control">
                                    <div class="form-switch">
                                        <input type="checkbox" id="typingIndicator" class="form-switch-input" checked>
                                        <label for="typingIndicator" class="form-switch-label"></label>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-item-info">
                                    <div class="setting-item-title">Show timestamps</div>
                                    <div class="setting-item-description">Display time information on chat messages
                                    </div>
                                </div>
                                <div class="setting-item-control">
                                    <div class="form-switch">
                                        <input type="checkbox" id="showTimestamps" class="form-switch-input" checked>
                                        <label for="showTimestamps" class="form-switch-label"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Models Tab -->
            <div class="tab-pane fade" id="ai-models" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>AI Model Configuration</h2>
                        <p>Configure the AI models used by your chatbots</p>
                    </div>

                    <div class="panel-body">
                        <div class="settings-section">
                            <h3>Flowise Configuration</h3>

                            <div class="form-group">
                                <label for="flowiseUrl" class="form-label">Flowise API URL</label>
                                <input type="text" id="flowiseUrl" class="form-control"
                                    value="http://localhost:3000/api">
                                <div class="form-text">The URL of your Flowise API endpoint</div>
                            </div>

                            <div class="form-group">
                                <label for="flowiseApiKey" class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="password" id="flowiseApiKey" class="form-control"
                                        value="your-api-key-here">
                                    <button class="btn btn-outline" type="button" id="toggleApiKey">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">Your Flowise API key for authentication</div>
                            </div>

                            <div class="form-group">
                                <label for="defaultChatflow" class="form-label">Default Chatflow ID</label>
                                <input type="text" id="defaultChatflow" class="form-control"
                                    value="275a8c78-fa28-494c-98a5-a0f102ea5753">
                                <div class="form-text">The default Chatflow ID to use when not specified in a chatbot
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>OpenAI Settings</h3>

                            <div class="setting-item">
                                <div class="setting-item-info">
                                    <div class="setting-item-title">API Key Status</div>
                                    <div class="setting-item-description">OpenAI API key is configured and working
                                        correctly</div>
                                </div>
                                <div class="setting-item-control">
                                    <span class="badge badge-success">Active</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="defaultModel" class="form-label">Default Model</label>
                                <select id="defaultModel" class="form-select">
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                                    <option value="claude-3-opus">Claude 3 Opus</option>
                                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                </select>
                                <div class="form-text">The default AI model to use for new chatbots</div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Model Parameters</h3>

                            <div class="form-group">
                                <label class="form-label">Default Temperature</label>
                                <div class="range-slider">
                                    <div class="range-label">
                                        <span>Precise</span>
                                        <span id="temperature-value">0.7</span>
                                        <span>Creative</span>
                                    </div>
                                    <input type="range" min="0" max="1" step="0.1" value="0.7" id="temperature-slider">
                                </div>
                                <div class="form-text">Controls the randomness of the AI responses. Lower values make
                                    responses more focused and deterministic.</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Max Tokens</label>
                                <select class="form-select">
                                    <option value="256">256 tokens</option>
                                    <option value="512">512 tokens</option>
                                    <option value="1024" selected>1024 tokens</option>
                                    <option value="2048">2048 tokens</option>
                                    <option value="4096">4096 tokens</option>
                                </select>
                                <div class="form-text">Maximum length of the AI response</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Departments Tab -->
            <div class="tab-pane fade" id="departments" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Department Management</h2>
                        <p>Configure departments for organizational structure</p>
                    </div>

                    <div class="panel-body">
                        <div class="settings-section">
                            <div class="section-header-actions">
                                <h3>Departments</h3>
                                <button class="btn btn-sm btn-primary" id="addDepartmentBtn">
                                    <i class="bi bi-plus"></i> Add Department
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Department Name</th>
                                            <th>Chatbots</th>
                                            <th>Users</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (ViewBag.Departments != null && ViewBag.Departments.Count > 0)
                                        {
                                            @foreach (var dept in ViewBag.Departments)
                                            {
                                                <tr data-department="@dept.Name">
                                                    <td>
                                                        <div class="department-name">@dept.Name</div>
                                                    </td>
                                                    <td>@dept.ChatbotCount</td>
                                                    <td>@dept.UserCount</td>
                                                    <td>
                                                        <div class="row-actions">
                                                            <button class="btn-icon edit-department" title="Edit">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn-icon delete-department" title="Delete" 
                                                                    @(dept.UserCount > 0 ? "disabled" : "")>
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center">No departments found</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department Modal -->
                <div class="modal fade" id="departmentModal" tabindex="-1" aria-labelledby="departmentModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="departmentModalLabel">Edit Department</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="departmentForm" method="post" asp-action="UpdateDepartment" asp-controller="Settings">
                                @Html.AntiForgeryToken()
                                <div class="modal-body">
                                    <input type="hidden" id="oldName" name="oldName" />
                                    <div class="mb-3">
                                        <label for="departmentName" class="form-label">Department Name</label>
                                        <input type="text" class="form-control" id="departmentName" name="newName" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="deleteForm" method="post" asp-action="DeleteDepartment" asp-controller="Settings">
                                @Html.AntiForgeryToken()
                                <div class="modal-body">
                                    <p>Are you sure you want to delete the department <strong
                                            id="deleteDepartmentName"></strong>?</p>
                                    <p class="text-danger">This cannot be undone. All associated data will be permanently
                                        removed.</p>
                                    <input type="hidden" id="departmentToDelete" name="departmentName" />
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder for other tabs -->
            <div class="tab-pane fade" id="notifications" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Notification Settings</h2>
                        <p>Configure email and system notifications</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="prompts" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Default Prompts</h2>
                        <p>Configure default system prompts for your chatbots</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="integrations" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Integrations</h2>
                        <p>Configure third-party integrations</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>User Management</h2>
                        <p>Manage users and permissions</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="api-keys" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>API Keys</h2>
                        <p>Manage API keys for external integrations</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="advanced" role="tabpanel">
                <div class="settings-panel">
                    <div class="panel-header">
                        <h2>Advanced Settings</h2>
                        <p>Configure advanced system settings</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Bootstrap components
            let departmentModalInstance = null;
            let deleteModalInstance = null;
            
            try {
                departmentModalInstance = new bootstrap.Modal(document.getElementById('departmentModal'));
                deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
            } catch (e) {
                console.error('Modal initialization error:', e);
            }

            // Add "show.bs.tab" event listener to ensure modals work only when departments tab is active
            const departmentsTab = document.querySelector('button[data-bs-target="#departments"]');
            const departmentsPane = document.getElementById('departments');
            let isDepartmentsTabActive = false;

            if (departmentsTab) {
                departmentsTab.addEventListener('show.bs.tab', function () {
                    isDepartmentsTabActive = true;
                });
                
                document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                    if (tab !== departmentsTab) {
                        tab.addEventListener('show.bs.tab', function () {
                            isDepartmentsTabActive = false;
                        });
                    }
                });
            }

            // Department management functionality
            const addDepartmentBtn = document.getElementById('addDepartmentBtn');
            const departmentForm = document.getElementById('departmentForm');
            const deleteForm = document.getElementById('deleteForm');

            // Add Department
            if (addDepartmentBtn) {
                addDepartmentBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (!isDepartmentsTabActive) return;
                    
                    // Reset form and change title
                    if (departmentForm) {
                        departmentForm.reset();
                        departmentForm.setAttribute('action', '@Url.Action("AddDepartment", "Settings")');
                    }
                    
                    if (document.getElementById('departmentModalLabel')) {
                        document.getElementById('departmentModalLabel').textContent = 'Add Department';
                    }
                    
                    if (document.getElementById('oldName')) {
                        document.getElementById('oldName').value = '';
                    }
                    
                    if (document.getElementById('departmentName')) {
                        document.getElementById('departmentName').value = '';
                    }
                    
                    // Show modal
                    if (departmentModalInstance) {
                        departmentModalInstance.show();
                    }
                });
            }

            // Edit Department - event delegation for dynamic elements
            document.getElementById('departments').addEventListener('click', function(e) {
                if (!isDepartmentsTabActive) return;
                
                // Check if the click was on an edit button or its child icon
                const editBtn = e.target.closest('.edit-department');
                if (!editBtn) return;
                
                e.preventDefault();
                
                // Get department data from parent row
                const departmentRow = editBtn.closest('tr');
                if (!departmentRow) return;
                
                const departmentName = departmentRow.getAttribute('data-department');
                if (!departmentName) return;
                
                // Set form values
                if (document.getElementById('departmentModalLabel')) {
                    document.getElementById('departmentModalLabel').textContent = 'Edit Department';
                }
                
                if (document.getElementById('oldName')) {
                    document.getElementById('oldName').value = departmentName;
                }
                
                if (document.getElementById('departmentName')) {
                    document.getElementById('departmentName').value = departmentName;
                }
                
                // Change form action
                if (departmentForm) {
                    departmentForm.setAttribute('action', '@Url.Action("UpdateDepartment", "Settings")');
                }
                
                // Show modal
                if (departmentModalInstance) {
                    departmentModalInstance.show();
                }
            });

            // Delete Department - event delegation
            document.getElementById('departments').addEventListener('click', function(e) {
                if (!isDepartmentsTabActive) return;
                
                // Check if the click was on a delete button or its child icon
                const deleteBtn = e.target.closest('.delete-department');
                if (!deleteBtn) return;
                
                // Don't trigger for disabled buttons
                if (deleteBtn.hasAttribute('disabled')) return;
                
                e.preventDefault();
                
                // Get department data from parent row
                const departmentRow = deleteBtn.closest('tr');
                if (!departmentRow) return;
                
                const departmentName = departmentRow.getAttribute('data-department');
                if (!departmentName) return;
                
                // Set confirmation text and form value
                if (document.getElementById('deleteDepartmentName')) {
                    document.getElementById('deleteDepartmentName').textContent = departmentName;
                }
                
                if (document.getElementById('departmentToDelete')) {
                    document.getElementById('departmentToDelete').value = departmentName;
                }
                
                // Show modal
                if (deleteModalInstance) {
                    deleteModalInstance.show();
                }
            });

            // Form validations
            if (departmentForm) {
                departmentForm.addEventListener('submit', function(e) {
                    const nameInput = document.getElementById('departmentName');
                    if (!nameInput || !nameInput.value.trim()) {
                        e.preventDefault();
                        showToast('error', 'Department name cannot be empty');
                        return false;
                    }
                    return true;
                });
            }

            // Handle success/error messages from TempData
            const showToast = function(type, message) {
                if (!message || message === '') return;
                
                const toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type === 'success' ? 'Success' : 'Error'}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Show toast
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                // Auto-hide toast after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 5000);
                
                // Close button functionality
                const closeBtn = toast.querySelector('.toast-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 300);
                    });
                }
            };
            
            // Display TempData messages if present
            @if (TempData["SuccessMessage"] != null)
            {
                <text>showToast('success', '@TempData["SuccessMessage"]');</text>
            }
            
            @if (TempData["ErrorMessage"] != null)
            {
                <text>showToast('error', '@TempData["ErrorMessage"]');</text>
            }

            // Tab functionality
            const tabLinks = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabLinks.forEach(link => {
                link.addEventListener('click', function () {
                    // Hide all tab panes
                    tabPanes.forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });

                    // Remove active class from all tab links
                    tabLinks.forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Show target tab pane
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    target.classList.add('show', 'active');
                });
            });

            // Toggle API Key visibility
            const toggleApiKey = document.getElementById('toggleApiKey');
            const apiKeyInput = document.getElementById('flowiseApiKey');

            if (toggleApiKey && apiKeyInput) {
                toggleApiKey.addEventListener('click', function () {
                    const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    apiKeyInput.setAttribute('type', type);

                    const icon = toggleApiKey.querySelector('i');
                    icon.classList.toggle('bi-eye');
                    icon.classList.toggle('bi-eye-slash');
                });
            }

            // Temperature slider
            const temperatureSlider = document.getElementById('temperature-slider');
            const temperatureValue = document.getElementById('temperature-value');

            if (temperatureSlider && temperatureValue) {
                temperatureSlider.addEventListener('input', function () {
                    temperatureValue.textContent = this.value;
                });
            }

            // Save settings notification
            const saveSettingsBtn = document.getElementById('saveSettings');

            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', function () {
                    // Show success toast
                    showToast('success', 'Your settings have been saved successfully');
                });
            }
        });
    </script>
}

@section Styles {
    <style>
        /* Settings Layout */
        .settings-layout {
            display: flex;
            gap: 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .settings-nav {
            width: 260px;
            flex-shrink: 0;
        }

        .settings-content {
            flex: 1;
            min-width: 0;
        }

        /* Settings Navigation */
        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-gray-500);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }

        .nav-tabs {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            font-size: 0.875rem;
            color: var(--color-gray-700);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .nav-link i {
            margin-right: 0.75rem;
            font-size: 1.125rem;
            color: var(--color-gray-500);
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            background-color: var(--color-gray-100);
            color: var(--color-gray-900);
        }

        .nav-link:hover i {
            color: var(--color-gray-700);
        }

        .nav-link.active {
            background-color: rgba(13, 110, 253, 0.1);
            color: var(--color-primary);
            font-weight: 500;
        }

        .nav-link.active i {
            color: var(--color-primary);
        }

        /* Settings Panel */
        .settings-panel {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 0.5rem;
        }

        .panel-header p {
            color: var(--color-gray-500);
            margin: 0;
            font-size: 0.875rem;
        }

        .panel-body {
            padding: 1.5rem;
        }

        /* Settings Sections */
        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .settings-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .settings-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 1.25rem;
            color: var(--color-gray-800);
        }

        .section-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .section-header-actions h3 {
            margin: 0;
        }

        /* Setting Item */
        .setting-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .setting-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .setting-item-info {
            flex: 1;
            min-width: 0;
            padding-right: 1.5rem;
        }

        .setting-item-title {
            font-weight: 500;
            color: var(--color-gray-800);
            margin-bottom: 0.25rem;
        }

        .setting-item-description {
            font-size: 0.75rem;
            color: var(--color-gray-500);
        }

        .setting-item-control {
            flex-shrink: 0;
        }

        /* Theme Options */
        .theme-options {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .theme-option {
            position: relative;
        }

        .theme-radio {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .theme-preview {
            width: 100px;
            height: 80px;
            border-radius: var(--border-radius);
            border: 2px solid var(--color-gray-300);
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-radio:checked+.theme-label .theme-preview {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }

        .light-theme {
            background-color: white;
        }

        .light-theme::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30%;
            height: 100%;
            background-color: #f8f9fa;
        }

        .dark-theme {
            background-color: #1f2937;
        }

        .dark-theme::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30%;
            height: 100%;
            background-color: #111827;
        }

        .system-theme {
            background: linear-gradient(to right, #f8f9fa 30%, white 30%);
        }

        .system-theme::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(31, 41, 55, 0.8) 50%);
            z-index: 1;
        }

        .theme-name {
            font-size: 0.875rem;
            color: var(--color-gray-700);
        }

        /* Color Options */
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .color-option {
            position: relative;
        }

        .color-radio {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .color-label {
            display: block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 0 1px var(--color-gray-300);
            transition: all 0.3s ease;
        }

        .color-radio:checked+.color-label {
            box-shadow: 0 0 0 2px var(--color), 0 0 0 4px rgba(var(--color), 0.3);
            transform: scale(1.1);
        }

        /* Range Slider */
        .range-slider {
            margin-top: 0.5rem;
        }

        .range-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-gray-700);
            margin-bottom: 0.5rem;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background-color: var(--color-gray-200);
            border-radius: 100px;
            appearance: none;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background-color: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Table styling */
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1rem;
        }

        .table th {
            font-weight: 600;
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-gray-200);
            color: var(--color-gray-700);
            background-color: var(--color-gray-50);
        }

        .table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--color-gray-200);
            vertical-align: middle;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .row-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            background-color: transparent;
            color: var(--color-gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background-color: var(--color-gray-100);
            color: var(--color-gray-800);
        }

        .btn-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal styles */
        .modal-content {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            border-bottom: 1px solid var(--color-gray-200);
            padding: 1.25rem 1.5rem;
        }

        .modal-header .btn-close {
            font-size: 1rem;
            padding: 0.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid var(--color-gray-200);
            padding: 1.25rem 1.5rem;
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 1050;
        }

        .toast {
            display: flex;
            align-items: flex-start;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            width: 320px;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #198754;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            color: #198754;
        }

        .toast.error .toast-icon {
            color: #dc3545;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--color-gray-600);
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--color-gray-500);
            cursor: pointer;
            padding: 0;
            margin-left: 0.75rem;
        }

        /* Responsive Adjustments */
        @@media(max-width: 991px) {
            .settings-layout {
                flex-direction: column;
            }

            .settings-nav {
                width: 100%;
            }

            .nav-tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .nav-item {
                margin-bottom: 0;
            }

            .nav-link {
                padding: 0.5rem 0.75rem;
            }

            .nav-link i {
                margin-right: 0.5rem;
            }
        }
    </style>
}